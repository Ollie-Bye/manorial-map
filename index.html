<!DOCTYPE html>
<html>
<head>
    <title>Manorial Map - Scalable Version</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; display: flex; height: 100vh; background: #1a1a1a; color: white; font-family: sans-serif; }
        #sidebar { width: 300px; padding: 20px; background: #2c3e50; overflow-y: auto; }
        #map { flex-grow: 1; background: #222; }
        .info-box { background: white; color: #333; padding: 15px; border-radius: 8px; margin-top: 15px; }
    </style>
</head>
<body>

<div id="sidebar">
    <h2>Dorset History</h2>
    <input type="range" id="yearSlider" min="1066" max="1922" value="1300" style="width:100%">
    <div id="yearLabel" style="font-size: 2em; text-align: center;">1300</div>
    <div id="details"><i>Click a manor to load data...</i></div>
</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map').setView([50.74, -2.21], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let currentShapes = null;
    let currentHistory = null;

    // THE FETCH MAGIC
    // This function can load ANY county just by changing the name
 async function loadCounty(countyName) {
    // We use the countyName variable to build the specific filename
    const shapePath = `data/${countyName}/${countyName}_shapes.json`;
    const historyPath = `data/${countyName}/${countyName}_history.json`;

    console.log("Fetching from:", shapePath);

    try {
        const shapeRes = await fetch(shapePath);
        if (!shapeRes.ok) throw new Error(`Status ${shapeRes.status} for ${shapePath}`);
        currentShapes = await shapeRes.json();

        const historyRes = await fetch(historyPath);
        if (!historyRes.ok) throw new Error(`Status ${historyRes.status} for ${historyPath}`);
        currentHistory = await historyRes.json();

        renderMap();
        console.log("Success! Data rendered.");
    } catch (err) {
        console.error("Fetch Error:", err);
    }
}

    function renderMap() {
        const year = document.getElementById('yearSlider').value;
        
        // Clear old layer
        map.eachLayer(lyr => { if(lyr.feature) map.removeLayer(lyr); });

        L.geoJSON(currentShapes, {
            style: { color: 'orange', fillOpacity: 0.4 },
            onEachFeature: (feature, layer) => {
                layer.on('click', () => {
                    const info = currentHistory.find(h => 
                        h.id === feature.properties.unit_id && 
                        year >= h.start && year <= h.end
                    );
                    
                    document.getElementById('details').innerHTML = info ? 
                        `<div class="info-box"><h3>${info.id}</h3><p>Lord: ${info.lord}</p></div>` : 
                        `<div class="info-box">No data for ${year}</div>`;
                });
            }
        }).addTo(map);
    }

    document.getElementById('yearSlider').oninput = (e) => {
        document.getElementById('yearLabel').innerText = e.target.value;
        renderMap();
    };

    // Initial load
    loadCounty('dorset');
</script>
</body>
</html>