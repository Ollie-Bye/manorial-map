<!DOCTYPE html>
<html>
<head>
    <title>Manorial Map - Scalable Version</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; display: flex; height: 100vh; background: #1a1a1a; color: white; font-family: sans-serif; }
        #sidebar { width: 300px; padding: 20px; background: #2c3e50; overflow-y: auto; }
        #map { flex-grow: 1; background: #222; }
        .info-box { background: white; color: #333; padding: 15px; border-radius: 8px; margin-top: 15px; }
    </style>
</head>
<body>

<div id="sidebar">
    <h2>Dorset History</h2>
    <input type="range" id="yearSlider" min="1066" max="1922" value="1300" style="width:100%">
    <div id="yearLabel" style="font-size: 2em; text-align: center;">1300</div>
    <div id="details"><i>Click a manor to load data...</i></div>
</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// 1. GLOBAL VARIABLES
let manifest = null;
let currentShapes = null;
let currentHistory = null;
let geojsonLayer = null;

const map = L.map('map').setView([52.0, -1.5], 7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

// 2. THE INITIALIZER
async function init() {
    try {
        const response = await fetch('./data/manifest.json');
        manifest = await response.json();
        setupCountySelector();
    } catch (err) {
        console.error("Failed to load manifest:", err);
    }
}

// 3. DROPDOWN MENU
function setupCountySelector() {
    const selector = document.createElement('select');
    selector.style = "position:absolute; top:10px; left:60px; z-index:1000; padding:5px;";
    selector.innerHTML = '<option value="">Select a County</option>' + 
        manifest.counties.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    
    selector.onchange = (e) => { if(e.target.value) loadCounty(e.target.value); };
    document.body.appendChild(selector);
}

// 4. THE LOADER
async function loadCounty(countyId) {
    const county = manifest.counties.find(c => c.id === countyId);
    try {
        const [shapeRes, histRes] = await Promise.all([
            fetch(`./data/${countyId}/${countyId}_shapes.json`),
            fetch(`./data/${countyId}/${countyId}_history.json`)
        ]);
        currentShapes = await shapeRes.json();
        currentHistory = await histRes.json();
        map.flyTo(county.center, county.zoom);
        renderMap();
    } catch (err) {
        console.error("Error loading county data:", err);
    }
}

// 5. THE RENDERER (This was missing!)
function renderMap() {
    const selectedYear = parseInt(document.getElementById('yearSlider').value);
    if (geojsonLayer) map.removeLayer(geojsonLayer);

    geojsonLayer = L.geoJSON(currentShapes, {
        style: { color: "#3498db", weight: 2, fillOpacity: 0.5 },
        onEachFeature: (feature, layer) => {
            layer.on('click', () => {
                const history = currentHistory[feature.properties.unit_id] || [];
                const record = history.find(r => selectedYear >= r.start && selectedYear <= r.end);
                document.getElementById('details').innerHTML = record ? `
                    <div class="info-box">
                        <h3>${feature.properties.name}</h3>
                        <p><b>Lord:</b> ${record.lord}</p>
                        <p><b>Notes:</b> ${record.notes || ''}</p>
                    </div>` : `<h3>${feature.properties.name}</h3><p>No data for this year.</p>`;
            });
        }
    }).addTo(map);
}

// 6. SLIDER LOGIC (This was also missing!)
document.getElementById('yearSlider').oninput = function() {
    document.getElementById('yearLabel').innerText = this.value;
    if (currentShapes) renderMap();
};

init(); 
</script>