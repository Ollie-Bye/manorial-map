<!DOCTYPE html>
<html>
<head>
    <title>Manorial Map - Scalable Version</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        <style>
    @import url('https://fonts.googleapis.com/css2?family=ABeeZee&display=swap');

    body { 
        margin: 0; 
        display: flex; 
        height: 100vh; 
        background: rgb(24, 34, 43); /* Dark Blue */
        color: rgb(240, 240, 240); /* Near White */
        font-family: 'ABeeZee', sans-serif;
    }

    #sidebar { 
        width: 380px; 
        background: rgb(34, 48, 60); /* Blue */
        display: flex;
        flex-direction: column;
        padding: 0;
        border-right: 1px solid rgba(255,255,255,0.1);
    }

    /* Header & Date Controls */
    .controls-container {
        padding: 20px;
        text-align: center;
        background: rgb(24, 34, 43);
    }

    .year-display {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
        font-size: 3rem;
    }

    .arrow {
        color: rgb(106, 140, 171); /* Light Blue */
        cursor: pointer;
        user-select: none;
    }

    input#yearInput {
        background: transparent;
        border: none;
        color: white;
        font-family: inherit;
        font-size: 3rem;
        width: 140px;
        text-align: center;
    }

    /* List of Objects */
    #objects-list {
        flex-grow: 1;
        overflow-y: auto;
        padding: 10px;
    }

    .manor-card {
        background: transparent;
        margin-bottom: 15px;
        border-radius: 8px;
    }

    .tenure-panel {
        background: rgb(24, 34, 43);
        padding: 15px;
        border-radius: 10px;
        margin-top: 10px;
        font-size: 0.9rem;
    }

    .type-pill {
        background: white;
        color: black;
        border-radius: 20px;
        padding: 5px 15px;
        display: inline-block;
        margin-bottom: 10px;
    }
</style>

<div id="sidebar">
    <div class="controls-container">
        <div class="year-display">
            <span class="arrow" onclick="adjustYear(-1)">‚óÄ</span>
            <input type="number" id="yearInput" value="1300" onchange="updateYear(this.value)">
            <span class="arrow" onclick="adjustYear(1)">‚ñ∂</span>
        </div>
        <input type="range" id="yearSlider" min="1066" max="1922" value="1300" style="width:100%; accent-color:rgb(106,140,171)">
        
        <div style="margin-top:15px;">
            <span class="type-pill">Seigneurial</span>
            <span style="opacity:0.6; margin-left:10px;">Ecclesiastical</span>
        </div>
    </div>
    
    <div id="objects-list">
        </div>
</div>
<div id="map"></div>
    </style>
</head>
<body>

<div id="sidebar">
    <h2>Dorset History</h2>
    <input type="range" id="yearSlider" min="1066" max="1922" value="1300" style="width:100%">
    <div id="yearLabel" style="font-size: 2em; text-align: center;">1300</div>
    <div id="details"><i>Click a manor to load data...</i></div>
</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// --- GLOBAL STATE ---
let currentShapes = null;
let currentHistory = null;
let geojsonLayer = null;

let selectedUnit = null; // Stores one unit_id
let activeUnits = [];   // Stores array of unit_ids
const activeColors = {}; // Stores color assignment for each ID

// --- INITIALIZATION ---
async function loadDorset() {
    try {
        const [shapeRes, histRes] = await Promise.all([
            fetch('./data/dorset/dorset_shapes.json'),
            fetch('./data/dorset/dorset_history.json')
        ]);
        currentShapes = await shapeRes.json();
        currentHistory = await histRes.json();
        renderMap();
    } catch (err) {
        console.error("Data load error:", err);
    }
}

const map = L.map('map').setView([50.74, -2.21], 10);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

// --- CORE LOGIC: MAP RENDERING ---
function renderMap() {
    if (geojsonLayer) map.removeLayer(geojsonLayer);

    const year = parseInt(document.getElementById('yearInput').value);

    geojsonLayer = L.geoJSON(currentShapes, {
        style: (feature) => {
            const id = feature.properties.unit_id;
            if (id === selectedUnit) return { color: "#3498db", weight: 5, fillOpacity: 0.8, zIndex: 1000 };
            if (activeUnits.includes(id)) return { color: getUnitColor(id), weight: 2, fillOpacity: 0.5 };
            return { color: "#7f8c8d", weight: 1, fillOpacity: 0.1 }; // Inactive
        },
        onEachFeature: (feature, layer) => {
            layer.on('click', () => handleUnitSelection(feature.properties.unit_id));
        }
    }).addTo(map);

    updateSidebar(year);
}

// --- SELECTION LOGIC ---
function handleUnitSelection(id) {
    if (selectedUnit === id) {
        // If clicking selected, it stays selected (or you could toggle it)
    } else {
        if (selectedUnit && !activeUnits.includes(selectedUnit)) {
            activeUnits.push(selectedUnit);
        }
        selectedUnit = id;
        // Remove from active if it's now selected
        activeUnits = activeUnits.filter(uid => uid !== id);
    }
    renderMap();
}

function getUnitColor(id) {
    if (!activeColors[id]) {
        const hues = [200, 280, 150, 30, 330]; // Blue, Purple, Green, Orange, Pink
        const hue = hues[Object.keys(activeColors).length % hues.length];
        activeColors[id] = `hsl(${hue}, 70%, 60%)`;
    }
    return activeColors[id];
}

// --- SIDEBAR UI GENERATION ---
function updateSidebar(year) {
    const list = document.getElementById('objects-list');
    list.innerHTML = ""; 

    // 1. Draw Selected Unit
    if (selectedUnit) {
        const feature = currentShapes.features.find(f => f.properties.unit_id === selectedUnit);
        const history = currentHistory[selectedUnit] || [];
        const record = history.find(r => year >= r.start && year <= r.end);
        
        const card = document.createElement('div');
        card.className = "manor-card";
        card.innerHTML = `
            <div class="card-header">
                <div>
                    <div style="font-size: 0.9rem; opacity: 0.8;">${record?.prefix || 'Manor of'}</div>
                    <div style="font-size: 1.8rem; font-weight: bold;">${feature.properties.name}</div>
                </div>
                <div style="font-size: 1.5rem; cursor:pointer;">
                    <span onclick="minimizeUnit('${selectedUnit}')">‚ûñ</span>
                    <span onclick="closeUnit('${selectedUnit}')">‚úñ</span>
                </div>
            </div>
            <div class="history-text">${record?.notes || 'No description available.'}</div>
            <div style="text-align:center; color:rgb(106,140,171); cursor:pointer;">Ô∏æ</div>
            
            <div class="tenure-panel">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span style="font-size: 1.1rem;">Tenure (1st Moiety)</span>
                    <span style="opacity:0.6">‚ùì</span>
                </div>
                <div style="margin-top:10px;">
                    <div style="color:rgb(106,140,171)">Overlord</div>
                    <div style="text-decoration: underline;">${record?.overlord || 'None'}</div>
                    <div style="font-size:0.8rem;">Of the <span style="text-decoration: underline;">${record?.house || 'N/A'}</span></div>
                    <div style="font-size:0.8rem;">As part of the <span style="text-decoration: underline;">${record?.honour || 'N/A'}</span></div>
                    <div style="color:rgb(106,140,171); margin-top:10px;">Lord</div>
                    <div style="font-size:1.2rem;">${record?.lord || 'None'}</div>
                </div>
            </div>
        `;
        list.appendChild(card);
    }

    // 2. Draw Active Units
    activeUnits.forEach(id => {
        const feature = currentShapes.features.find(f => f.properties.unit_id === id);
        const activeCard = document.createElement('div');
        activeCard.style = `border-left: 5px solid ${getUnitColor(id)}; padding: 10px; background: rgba(0,0,0,0.2); margin-top:10px; display:flex; justify-content:space-between; align-items:center; border-radius: 4px;`;
        activeCard.innerHTML = `
            <span>${feature.properties.name}</span>
            <div style="cursor:pointer;">
                <span onclick="maximizeUnit('${id}')">üìã</span>
                <span onclick="closeUnit('${id}')">‚úñ</span>
            </div>
        `;
        list.appendChild(activeCard);
    });
}

// --- INTERFACE HELPERS ---
function minimizeUnit(id) {
    if (!activeUnits.includes(id)) activeUnits.push(id);
    selectedUnit = null;
    renderMap();
}

function closeUnit(id) {
    activeUnits = activeUnits.filter(uid => uid !== id);
    if (selectedUnit === id) selectedUnit = null;
    renderMap();
}

function maximizeUnit(id) {
    handleUnitSelection(id);
}

function changeYear(delta) {
    const input = document.getElementById('yearInput');
    const slider = document.getElementById('yearSlider');
    const newYear = parseInt(input.value) + delta;
    input.value = newYear;
    slider.value = newYear;
    renderMap();
}

function updateYear(val) {
    document.getElementById('yearSlider').value = val;
    renderMap();
}

document.getElementById('yearSlider').oninput = function() {
    document.getElementById('yearInput').value = this.value;
    renderMap();
};

document.getElementById('yearInput').onchange = function() {
    updateYear(this.value);
};

// Start
loadDorset();
</script>