<!DOCTYPE html>
<html>
<head>
    <title>Manorial Map - Scalable Version</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; display: flex; height: 100vh; background: #1a1a1a; color: white; font-family: sans-serif; }
        #sidebar { width: 300px; padding: 20px; background: #2c3e50; overflow-y: auto; }
        #map { flex-grow: 1; background: #222; }
        .info-box { background: white; color: #333; padding: 15px; border-radius: 8px; margin-top: 15px; }
    </style>
</head>
<body>

<div id="sidebar">
    <h2>Dorset History</h2>
    <input type="range" id="yearSlider" min="1066" max="1922" value="1300" style="width:100%">
    <div id="yearLabel" style="font-size: 2em; text-align: center;">1300</div>
    <div id="details"><i>Click a manor to load data...</i></div>
</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// Global variables to store our "Brain" and "Body"
let manifest = null;
let currentShapes = null;
let currentHistory = null;
const map = L.map('map').setView([52.0, -1.5], 7); // Start centered on England

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

// 1. Load the Manifest first
async function init() {
    const response = await fetch('data/manifest.json');
    manifest = await response.json();
    setupCountySelector();
}

// 2. Dynamically build a dropdown menu (or you can just click the map)
function setupCountySelector() {
    const selector = document.createElement('select');
    selector.style.position = 'absolute';
    selector.style.top = '10px';
    selector.style.left = '50px';
    selector.style.zIndex = '1000';
    
    selector.innerHTML = '<option>Select a County</option>' + 
        manifest.counties.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    
    selector.onchange = (e) => loadCounty(e.target.value);
    document.body.appendChild(selector);
}

// 3. The "Loader" - This works for ANY county you add in the future
async function loadCounty(countyId) {
    const county = manifest.counties.find(c => c.id === countyId);
    
    // Fetch both files at once
    const [shapeRes, histRes] = await Promise.all([
        fetch(`data/${countyId}/${countyId}_shapes.json`),
        fetch(`data/${countyId}/${countyId}_history.json`)
    ]);

    currentShapes = await shapeRes.json();
    currentHistory = await histRes.json();

    map.flyTo(county.center, county.zoom);
    renderMap();
}

// ... Keep your existing renderMap and slider logic here ...

init(); // Start the engine