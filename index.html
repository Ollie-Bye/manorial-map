<!DOCTYPE html>
<html>
<head>
    <title>Manorial Map - Scalable Version</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; display: flex; height: 100vh; background: #1a1a1a; color: white; font-family: sans-serif; }
        #sidebar { width: 300px; padding: 20px; background: #2c3e50; overflow-y: auto; }
        #map { flex-grow: 1; background: #222; }
        .info-box { background: white; color: #333; padding: 15px; border-radius: 8px; margin-top: 15px; }
    </style>
</head>
<body>

<div id="sidebar">
    <h2>Dorset History</h2>
    <input type="range" id="yearSlider" min="1066" max="1922" value="1300" style="width:100%">
    <div id="yearLabel" style="font-size: 2em; text-align: center;">1300</div>
    <div id="details"><i>Click a manor to load data...</i></div>
</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// 1. Setup Map
const map = L.map('map').setView([50.74, -2.21], 10); // Starts right over Dorset
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

// 2. Global Data Storage
let currentShapes = null;
let currentHistory = null;
let geojsonLayer = null;

// 3. The Simple Loader (Points directly to your folders)
async function loadDorset() {
    try {
        const shapeRes = await fetch('./data/dorset/dorset_shapes.json');
        const histRes = await fetch('./data/dorset/dorset_history.json');
        
        currentShapes = await shapeRes.json();
        currentHistory = await histRes.json();
        
        console.log("Dorset data loaded successfully!");
        renderMap();
    } catch (err) {
        console.error("Error: Could not find the files in /data/dorset/. Check your folder names!", err);
    }
}

// 4. The Renderer
function renderMap() {
    const selectedYear = parseInt(document.getElementById('yearSlider').value);
    if (geojsonLayer) map.removeLayer(geojsonLayer);

    geojsonLayer = L.geoJSON(currentShapes, {
        style: { color: "#3498db", weight: 2, fillOpacity: 0.5 },
        onEachFeature: (feature, layer) => {
            layer.on('click', () => {
                const history = currentHistory[feature.properties.unit_id] || [];
                const record = history.find(r => selectedYear >= r.start && selectedYear <= r.end);
                
                document.getElementById('details').innerHTML = record ? `
                    <div class="info-box">
                        <h3>${feature.properties.name}</h3>
                        <p><b>Lord:</b> ${record.lord}</p>
                        <p><b>Notes:</b> ${record.notes || ''}</p>
                    </div>` : `<h3>${feature.properties.name}</h3><p>No data for 1066-1922.</p>`;
            });
        }
    }).addTo(map);
}

// 5. Slider Logic
document.getElementById('yearSlider').oninput = function() {
    document.getElementById('yearLabel').innerText = this.value;
    if (currentShapes) renderMap();
};

// 6. Start!
loadDorset();
</script>