<!DOCTYPE html>
<html>
<head>
    <title>Manorial Map - Scalable Version</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        <style>
    /* Sidebar Panels */
.tenure-panel {
    background: #f9f7f2;
    border: 1px solid #d4c5a9;
    padding: 15px;
    margin-top: 20px;
    font-family: 'Crimson Text', serif;
}

/* History Dropdown Logic */
.history-section summary {
    cursor: pointer;
    font-weight: bold;
    padding: 10px 0;
    list-style: none; /* Removes default arrow */
    display: flex;
    justify-content: space-between;
}

.history-section summary::-webkit-details-marker {
    display: none; /* Hides arrow in Safari */
}

.history-section summary:after {
    content: "︾"; /* Your exact icon */
    color: #6a8cab;
}

.history-section[open] summary:after {
    content: "︽";
}
    }
</style>

<div id="sidebar">
    <div class="controls-container">
        <div class="year-display">
            <span class="arrow" onclick="adjustYear(-1)">◀</span>
            <input type="number" id="yearInput" value="1300" onchange="updateYear(this.value)">
            <span class="arrow" onclick="adjustYear(1)">▶</span>
        </div>
        <input type="range" id="yearSlider" min="1066" max="1922" value="1300" style="width:100%; accent-color:rgb(106,140,171)">
        
        <div style="margin-top:15px;">
            <span class="type-pill">Seigneurial</span>
            <span style="opacity:0.6; margin-left:10px;">Ecclesiastical</span>
        </div>
    </div>
    
    <div id="objects-list">
        </div>
</div>
<div id="map"></div>
    </style>
</head>
<body>

<div id="sidebar">
    <h2>Dorset History</h2>
    <input type="range" id="yearSlider" min="1066" max="1922" value="1300" style="width:100%">
    <div id="yearLabel" style="font-size: 2em; text-align: center;">1300</div>
    <div id="details"><i>Click a manor to load data...</i></div>
</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
let currentHistory = {};
let currentShapes = null;
let map, geojsonLayer;
let selectedUnit = null;

// 1. Initialize the Map
map = L.map('map').setView([50.75, -2.2], 11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

// 2. Load the Data
async function loadData() {
    try {
        // Load your new JSON
        const historyRes = await fetch('data/dorset/dorset_history.json');
        currentHistory = await historyRes.json();

        // Load your GeoJSON shapes
        const shapesRes = await fetch('data/dorset/shapes.json'); // Ensure this filename is correct!
        currentShapes = await shapesRes.json();

        renderMap();
    } catch (err) {
        console.error("Error loading data files:", err);
    }
}

function renderMap() {
    if (geojsonLayer) map.removeLayer(geojsonLayer);

    const year = parseInt(document.getElementById('yearInput').value);

    geojsonLayer = L.geoJSON(currentShapes, {
        filter: (feature) => {
            const id = feature.properties.unit_id;
            const history = currentHistory[id] || [];
            const record = history.find(r => year >= r.start && year <= r.end);

            // If there's a record, and it specifies a geometry_file, 
            // only show this polygon if it matches that file name.
            if (record && record.geometry_file) {
                return feature.properties.file_name === record.geometry_file;
            }
            return true; // Otherwise show the base polygon
        },
        style: (feature) => {
            const id = feature.properties.unit_id;
            const isSelected = (id === selectedUnit);
            return {
                color: isSelected ? "#3498db" : "#7f8c8d",
                weight: isSelected ? 4 : 1,
                fillOpacity: isSelected ? 0.7 : 0.2,
                fillColor: "#2c3e50"
            };
        },
        onEachFeature: (feature, layer) => {
            layer.on('click', () => {
                selectedUnit = feature.properties.unit_id;
                renderMap();
                updateSidebar(year);
            });
        }
    }).addTo(map);

    updateSidebar(year);
}

function updateSidebar(year) {
    const sidebar = document.getElementById('sidebar-content');
    if (!selectedUnit || !currentHistory[selectedUnit]) return;

    const history = currentHistory[selectedUnit];
    const record = history.find(r => year >= r.start && year <= r.end) || history[0];

    const moietyLabel = record.moiety ? `(${record.moiety} Moiety)` : "";

    sidebar.innerHTML = `
        <div class="unit-header">
            <div style="color: #666; text-transform: uppercase; font-size: 0.8rem;">${record.prefix}</div>
            <h1 style="margin: 0; font-family: 'Old Standard TT', serif;">${record.name || selectedUnit}</h1>
        </div>

        <div class="tenure-panel">
            <div style="display:flex; justify-content:space-between; border-bottom: 1px solid #d4c5a9; padding-bottom:5px;">
                <span style="font-weight:bold;">Tenure</span>
                <span style="font-style:italic; color:#888;">${moietyLabel}</span>
            </div>
            
            <div style="margin-top:15px;">
                <div style="color:#6a8cab; font-size:0.9rem;">Held of</div>
                <div style="text-decoration: underline;">${record.overlord || 'The King'}</div>
                
                <div style="color:#6a8cab; font-size:0.9rem; margin-top:15px;">Lord</div>
                <div style="font-size:1.3rem;">${record.lord || '<em>Information Missing</em>'}</div>
                <div style="color:#888; font-size:0.9rem;">House of ${record.lord_family || 'Unknown'}</div>
            </div>
        </div>

        <details class="history-section" style="margin-top:20px;">
            <summary>History</summary>
            <p style="font-size:0.95rem; line-height:1.6;">${record.description || "No description available for this period."}</p>
        </details>
    `;
}

// Start the app
loadData();
</script>